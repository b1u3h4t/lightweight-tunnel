# è½»é‡çº§å†…ç½‘éš§é“

ä¸€ä¸ªä½¿ç”¨ Go è¯­è¨€å¼€å‘çš„è½»é‡çº§å†…ç½‘éš§é“å·¥å…·ï¼Œæ”¯æŒ TCP ä¼ªè£…å’Œ FEC çº é”™åŠŸèƒ½ï¼Œé€‚ç”¨äºåœ¨å¤šä¸ªæœåŠ¡å™¨ä¹‹é—´å»ºç«‹å®‰å…¨çš„è™šæ‹Ÿå†…ç½‘è¿æ¥ã€‚

## ä¸»è¦ç‰¹æ€§

- ğŸš€ **è½»é‡é«˜æ•ˆ** - èµ„æºå ç”¨å°‘ï¼Œé€‚åˆä½é…ç½®æœåŠ¡å™¨
- ğŸ”’ **TCP ä¼ªè£…** - æ•°æ®åŒ…ä¼ªè£…æˆæ™®é€š TCP è¿æ¥ï¼Œå¯ç©¿é€é˜²ç«å¢™
- ğŸ” **TLS åŠ å¯†** - å¯é€‰çš„ TLS åŠ å¯†ä¿æŠ¤æµé‡ä¸è¢«è¿è¥å•†æ£€æŸ¥
- ğŸ›¡ï¸ **FEC çº é”™** - è‡ªåŠ¨çº æ­£ä¸¢åŒ…ï¼Œæå‡å¼±ç½‘ç¯å¢ƒä¸‹çš„ç¨³å®šæ€§
- ğŸŒ **å¤šå®¢æˆ·ç«¯** - æ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¿æ¥ï¼Œå®¢æˆ·ç«¯ä¹‹é—´å¯äº’ç›¸é€šä¿¡
- âš¡ **é«˜æ€§èƒ½** - åŸºäº Go åç¨‹å®ç°é«˜å¹¶å‘å¤„ç†
- ğŸ¯ **ç®€å•æ˜“ç”¨** - æ”¯æŒå‘½ä»¤è¡Œå’Œé…ç½®æ–‡ä»¶ä¸¤ç§æ–¹å¼

## âš ï¸ å®‰å…¨æé†’

**é»˜è®¤æƒ…å†µä¸‹ï¼Œéš§é“æµé‡æ˜¯æ˜æ–‡ä¼ è¾“çš„**ï¼Œè¿è¥å•†å’Œç½‘ç»œè®¾å¤‡å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å†…å®¹ã€‚ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…å¯ç”¨ TLS åŠ å¯†ï¼è¯¦è§ [SECURITY.md](SECURITY.md)ã€‚

## å¿«é€Ÿå¼€å§‹

### ç³»ç»Ÿè¦æ±‚

- Linux ç³»ç»Ÿï¼ˆéœ€è¦ TUN è®¾å¤‡æ”¯æŒï¼‰
- Root æƒé™ï¼ˆç”¨äºåˆ›å»ºå’Œé…ç½® TUN è®¾å¤‡ï¼‰
- Go 1.19+ ï¼ˆä»…ç¼–è¯‘æ—¶éœ€è¦ï¼‰

### å®‰è£…

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/openbmx/lightweight-tunnel.git
cd lightweight-tunnel

# ç¼–è¯‘
go build -o lightweight-tunnel ./cmd/lightweight-tunnel

# æˆ–è€…ç›´æ¥å®‰è£…
go install ./cmd/lightweight-tunnel
```

### åŸºæœ¬ä½¿ç”¨

#### åœºæ™¯ä¸€ï¼šç®€å•çš„ç‚¹å¯¹ç‚¹è¿æ¥ï¼ˆæµ‹è¯•ç”¨ï¼‰

**æœåŠ¡ç«¯ï¼š**
```bash
sudo ./lightweight-tunnel -m server -l 0.0.0.0:9000 -t 10.0.0.1/24
```

**å®¢æˆ·ç«¯ï¼š**
```bash
sudo ./lightweight-tunnel -m client -r æœåŠ¡å™¨IP:9000 -t 10.0.0.2/24
```

**æµ‹è¯•è¿æ¥ï¼š**
```bash
# åœ¨å®¢æˆ·ç«¯æ‰§è¡Œ
ping 10.0.0.1
```

#### åœºæ™¯äºŒï¼šä½¿ç”¨ TLS åŠ å¯†ï¼ˆæ¨èï¼‰

**1. ç”Ÿæˆè¯ä¹¦ï¼ˆæµ‹è¯•ç”¨ï¼‰ï¼š**
```bash
./examples/generate-certs.sh
```

**2. å¯åŠ¨æœåŠ¡ç«¯ï¼š**
```bash
sudo ./lightweight-tunnel -m server -l 0.0.0.0:9000 -t 10.0.0.1/24 \
  -tls -tls-cert certs/server.crt -tls-key certs/server.key
```

**3. å¯åŠ¨å®¢æˆ·ç«¯ï¼š**
```bash
# ä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
sudo ./lightweight-tunnel -m client -r æœåŠ¡å™¨IP:9000 -t 10.0.0.2/24 \
  -tls -tls-skip-verify

# ä½¿ç”¨æ­£å¼è¯ä¹¦ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
sudo ./lightweight-tunnel -m client -r æœåŠ¡å™¨IP:9000 -t 10.0.0.2/24 -tls
```

#### åœºæ™¯ä¸‰ï¼šå¤šå®¢æˆ·ç«¯ç»„ç½‘

æœåŠ¡ç«¯é»˜è®¤æ”¯æŒå¤šå®¢æˆ·ç«¯è¿æ¥ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯å¯ä»¥äº’ç›¸é€šä¿¡ï¼š

**æœåŠ¡ç«¯ï¼š**
```bash
sudo ./lightweight-tunnel -m server -l 0.0.0.0:9000 -t 10.0.0.1/24
```

**å®¢æˆ·ç«¯ 1ï¼š**
```bash
sudo ./lightweight-tunnel -m client -r æœåŠ¡å™¨IP:9000 -t 10.0.0.2/24
```

**å®¢æˆ·ç«¯ 2ï¼š**
```bash
sudo ./lightweight-tunnel -m client -r æœåŠ¡å™¨IP:9000 -t 10.0.0.3/24
```

**å®¢æˆ·ç«¯ 3ï¼š**
```bash
sudo ./lightweight-tunnel -m client -r æœåŠ¡å™¨IP:9000 -t 10.0.0.4/24
```

è¿æ¥åï¼Œå®¢æˆ·ç«¯ä¹‹é—´å¯ä»¥ç›´æ¥é€šä¿¡ï¼š
```bash
# åœ¨å®¢æˆ·ç«¯ 1 ä¸Š ping å®¢æˆ·ç«¯ 2
ping 10.0.0.3

# åœ¨å®¢æˆ·ç«¯ 1 ä¸Š SSH åˆ°å®¢æˆ·ç«¯ 3
ssh user@10.0.0.4
```

### ä½¿ç”¨é…ç½®æ–‡ä»¶

#### ç”Ÿæˆç¤ºä¾‹é…ç½®

```bash
./lightweight-tunnel -g config.json
# ä¼šç”Ÿæˆ config.jsonï¼ˆæœåŠ¡ç«¯ï¼‰å’Œ config.json.clientï¼ˆå®¢æˆ·ç«¯ï¼‰
```

#### æœåŠ¡ç«¯é…ç½®ç¤ºä¾‹

```json
{
  "mode": "server",
  "local_addr": "0.0.0.0:9000",
  "tunnel_addr": "10.0.0.1/24",
  "mtu": 1400,
  "fec_data": 10,
  "fec_parity": 3,
  "timeout": 30,
  "keepalive": 10,
  "send_queue_size": 1000,
  "recv_queue_size": 1000,
  "multi_client": true,
  "max_clients": 100,
  "client_isolation": false,
  "tls_enabled": false,
  "tls_cert_file": "/path/to/server.crt",
  "tls_key_file": "/path/to/server.key"
}
```

**é‡è¦è¯´æ˜ï¼š**
- `multi_client`ï¼šæœªæŒ‡å®šæ—¶é»˜è®¤ä¸º `true`ï¼Œå…è®¸å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¿æ¥
- å¦‚éœ€é™åˆ¶ä¸ºå•å®¢æˆ·ç«¯æ¨¡å¼ï¼Œæ˜¾å¼è®¾ç½®ä¸º `false`

#### å®¢æˆ·ç«¯é…ç½®ç¤ºä¾‹

```json
{
  "mode": "client",
  "remote_addr": "æœåŠ¡å™¨IP:9000",
  "tunnel_addr": "10.0.0.2/24",
  "mtu": 1400,
  "fec_data": 10,
  "fec_parity": 3,
  "timeout": 30,
  "keepalive": 10,
  "send_queue_size": 1000,
  "recv_queue_size": 1000,
  "tls_enabled": false,
  "tls_skip_verify": false
}
```

#### ä½¿ç”¨é…ç½®æ–‡ä»¶è¿è¡Œ

```bash
sudo ./lightweight-tunnel -c config.json
```

## é…ç½®è¯´æ˜

### å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `-c` | é…ç½®æ–‡ä»¶è·¯å¾„ | - |
| `-m` | æ¨¡å¼ï¼šserver æˆ– client | server |
| `-l` | ç›‘å¬åœ°å€ï¼ˆæœåŠ¡ç«¯ï¼‰ | 0.0.0.0:9000 |
| `-r` | æœåŠ¡å™¨åœ°å€ï¼ˆå®¢æˆ·ç«¯ï¼‰ | - |
| `-t` | éš§é“ IP åœ°å€å’Œå­ç½‘æ©ç  | 10.0.0.1/24 |
| `-mtu` | MTU å¤§å° | 1400 |
| `-fec-data` | FEC æ•°æ®åˆ†ç‰‡æ•° | 10 |
| `-fec-parity` | FEC æ ¡éªŒåˆ†ç‰‡æ•° | 3 |
| `-send-queue` | å‘é€é˜Ÿåˆ—å¤§å° | 1000 |
| `-recv-queue` | æ¥æ”¶é˜Ÿåˆ—å¤§å° | 1000 |
| `-multi-client` | å¯ç”¨å¤šå®¢æˆ·ç«¯æ”¯æŒï¼ˆæœåŠ¡ç«¯ï¼‰ | true |
| `-max-clients` | æœ€å¤§å®¢æˆ·ç«¯æ•°é‡ï¼ˆæœåŠ¡ç«¯ï¼‰ | 100 |
| `-client-isolation` | å®¢æˆ·ç«¯éš”ç¦»æ¨¡å¼ | false |
| `-tls` | å¯ç”¨ TLS åŠ å¯† | false |
| `-tls-cert` | TLS è¯ä¹¦æ–‡ä»¶ï¼ˆæœåŠ¡ç«¯ï¼‰ | - |
| `-tls-key` | TLS ç§é’¥æ–‡ä»¶ï¼ˆæœåŠ¡ç«¯ï¼‰ | - |
| `-tls-skip-verify` | è·³è¿‡è¯ä¹¦éªŒè¯ï¼ˆå®¢æˆ·ç«¯ï¼Œä¸å®‰å…¨ï¼‰ | false |
| `-v` | æ˜¾ç¤ºç‰ˆæœ¬ | - |
| `-g` | ç”Ÿæˆç¤ºä¾‹é…ç½®æ–‡ä»¶ | - |

### å¤šå®¢æˆ·ç«¯é…ç½®é€‰é¡¹

**Hub æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼š** æ‰€æœ‰å®¢æˆ·ç«¯å¯ä»¥äº’ç›¸é€šä¿¡
```bash
sudo ./lightweight-tunnel -m server -l 0.0.0.0:9000 -t 10.0.0.1/24
```

**å®¢æˆ·ç«¯éš”ç¦»æ¨¡å¼ï¼š** å®¢æˆ·ç«¯åªèƒ½ä¸æœåŠ¡ç«¯é€šä¿¡ï¼Œä¸èƒ½äº’è®¿
```bash
sudo ./lightweight-tunnel -m server -l 0.0.0.0:9000 -t 10.0.0.1/24 -client-isolation
```

**å•å®¢æˆ·ç«¯æ¨¡å¼ï¼š** åªå…è®¸ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥
```bash
sudo ./lightweight-tunnel -m server -l 0.0.0.0:9000 -t 10.0.0.1/24 -multi-client=false
```

## æ€§èƒ½è°ƒä¼˜

### é«˜é€Ÿç½‘ç»œç¯å¢ƒ

```bash
# å¢å¤§ MTU
sudo ./lightweight-tunnel -mtu 8000 ...

# å‡å°‘ FEC å¼€é”€
sudo ./lightweight-tunnel -fec-data 20 -fec-parity 2 ...
```

### é«˜ä¸¢åŒ…ç½‘ç»œç¯å¢ƒ

```bash
# å¢åŠ  FEC å†—ä½™
sudo ./lightweight-tunnel -fec-data 10 -fec-parity 5 ...

# å‡å° MTU
sudo ./lightweight-tunnel -mtu 1200 ...
```

### é«˜å¸¦å®½åœºæ™¯

å¦‚æœçœ‹åˆ° "Send queue full, dropping packet" é”™è¯¯ï¼Œå¢å¤§é˜Ÿåˆ—ï¼š
```bash
sudo ./lightweight-tunnel -send-queue 5000 -recv-queue 5000 ...
```

å»ºè®®å€¼ï¼š
- æ™®é€šä½¿ç”¨ï¼š1000-5000
- é«˜å¸¦å®½éš§é“ï¼š5000-10000

## å¸¸è§é—®é¢˜

### æƒé™é”™è¯¯

**é—®é¢˜ï¼š** `failed to open /dev/net/tun: permission denied`

**è§£å†³ï¼š** ä½¿ç”¨ root æƒé™è¿è¡Œ
```bash
sudo ./lightweight-tunnel ...
```

### TUN è®¾å¤‡ä¸å­˜åœ¨

**é—®é¢˜ï¼š** `/dev/net/tun: no such file or directory`

**è§£å†³ï¼š** åŠ è½½ TUN æ¨¡å—
```bash
sudo modprobe tun
```

### æ— æ³•è¿æ¥æœåŠ¡å™¨

**æ’æŸ¥æ­¥éª¤ï¼š**
1. æ£€æŸ¥æœåŠ¡ç«¯æ˜¯å¦è¿è¡Œï¼š`netstat -tlnp | grep 9000`
2. æ£€æŸ¥é˜²ç«å¢™ï¼š`sudo ufw allow 9000/tcp`
3. éªŒè¯æœåŠ¡å™¨ IP åœ°å€æ˜¯å¦æ­£ç¡®
4. æµ‹è¯•ç½‘ç»œè¿é€šæ€§ï¼š`ping æœåŠ¡å™¨IP`

### ç¬¬äºŒä¸ªå®¢æˆ·ç«¯è¿æ¥å¤±è´¥ï¼ˆEOF/Broken Pipeï¼‰

**é—®é¢˜ï¼š** ç¬¬äºŒä¸ªå®¢æˆ·ç«¯æŠ¥é”™ "Network read error: EOF" æˆ– "write: broken pipe"

**åŸå› ï¼š** æœåŠ¡ç«¯é…ç½®ä¸ºå•å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆ`multi_client: false`ï¼‰

**è§£å†³æ–¹æ¡ˆï¼š**

ä½¿ç”¨ JSON é…ç½®æ–‡ä»¶æ—¶ï¼š
```json
{
  "mode": "server",
  "local_addr": "0.0.0.0:9000",
  "tunnel_addr": "10.0.0.1/24",
  "multi_client": true,
  "max_clients": 100
}
```

ä½¿ç”¨å‘½ä»¤è¡Œæ—¶ï¼ˆé»˜è®¤å·²å¯ç”¨ï¼‰ï¼š
```bash
sudo ./lightweight-tunnel -m server -l 0.0.0.0:9000 -t 10.0.0.1/24
```

### ç«¯å£è¢«å ç”¨

**é—®é¢˜ï¼š** `bind: address already in use`

**è§£å†³ï¼š** æŸ¥æ‰¾å¹¶å…³é—­å ç”¨ç«¯å£çš„è¿›ç¨‹
```bash
# æŸ¥æ‰¾è¿›ç¨‹
sudo lsof -i :9000

# ç»ˆæ­¢è¿›ç¨‹
sudo kill -9 PID
```

## å·¥ä½œåŸç†

1. **TUN è®¾å¤‡ï¼š** åˆ›å»ºè™šæ‹Ÿç½‘å¡ï¼Œå¤„ç†ä¸‰å±‚ IP æ•°æ®åŒ…
2. **TCP ä¼ªè£…ï¼š** å°†æ•°æ®åŒ…å°è£…åœ¨ TCP è¿æ¥ä¸­ï¼Œç©¿é€é˜²ç«å¢™
3. **TLS åŠ å¯†ï¼š** å¯é€‰çš„ç«¯åˆ°ç«¯åŠ å¯†ï¼Œé˜²æ­¢è¿è¥å•†æ£€æŸ¥å†…å®¹
4. **FEC çº é”™ï¼š** æ·»åŠ å†—ä½™æ•°æ®åˆ†ç‰‡ï¼Œè‡ªåŠ¨æ¢å¤ä¸¢å¤±çš„æ•°æ®åŒ…
5. **ä¿æ´»æœºåˆ¶ï¼š** å®šæœŸå‘é€å¿ƒè·³åŒ…ç»´æŒè¿æ¥

## æ¶æ„å›¾

```
                    æœåŠ¡ç«¯ (10.0.0.1)
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
   å®¢æˆ·ç«¯ 1           å®¢æˆ·ç«¯ 2           å®¢æˆ·ç«¯ 3
  (10.0.0.2)        (10.0.0.3)        (10.0.0.4)
        â”‚                 â”‚                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              å¯ä»¥äº’ç›¸é€šä¿¡ï¼ˆHub æ¨¡å¼ï¼‰

          TCP è¿æ¥ï¼ˆå¯é€‰ TLS åŠ å¯†ï¼‰
              â†“
        FEC çº é”™ + TCP ä¼ªè£…
              â†“
         TUN è™šæ‹Ÿç½‘å¡
```

## é™åˆ¶è¯´æ˜

- ç›®å‰ä»…æ”¯æŒ IPv4
- éœ€è¦ root æƒé™åˆ›å»º TUN è®¾å¤‡
- ä»…æ”¯æŒ Linux ç³»ç»Ÿ
- é»˜è®¤ä¸åŠ å¯†ï¼Œéœ€æ‰‹åŠ¨å¯ç”¨ TLS
- æ‰€æœ‰æµé‡ç»è¿‡æœåŠ¡ç«¯ä¸­è½¬

## å®‰å…¨å»ºè®®

æ›´å¤šå®‰å…¨ä¿¡æ¯è¯·å‚é˜… [SECURITY.md](SECURITY.md)ï¼ŒåŒ…æ‹¬ï¼š
- è¿è¥å•†å¯è§æ€§å’Œæ·±åº¦åŒ…æ£€æµ‹ï¼ˆDPIï¼‰
- TLS åŠ å¯†é…ç½®
- GFW å’Œç½‘ç»œç›‘æ§è€ƒé‡
- å¨èƒæ¨¡å‹å’Œæœ€ä½³å®è·µ

## å‚è€ƒé¡¹ç›®

- [udp2raw](https://github.com/wangyu-/udp2raw) - UDP åˆ° TCP è½¬æ¢å·¥å…·
- [tinyfecvpn](https://github.com/wangyu-/tinyfecVPN) - å¸¦ FEC çš„ VPN

## å¼€æºåè®®

MIT License

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Pull Request å’Œ Issueï¼
